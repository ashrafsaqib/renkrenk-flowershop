{{ header }}
<div id="subscription-info" class="container">
  <div class="row">{{ column_left }}
    <div id="content" class="col">
      {{ content_top }}

      
      <div class="row mb-3">
        {% if thumb or images %}
          <div class="col-sm-6">
            <div class="image magnific-popup">
              {% if thumb %}
                <a href="{{ image }}" title="{{ heading_title }}"><img src="{{ thumb }}" title="{{ heading_title }}" alt="{{ heading_title }}" class="img-thumbnail mb-3"/></a>
              {% endif %}
              {% if images %}
                <div>
                  {% for image in images %}
                    <a href="{{ image.popup }}" title="{{ heading_title }}"><img src="{{ image.thumb }}" title="{{ heading_title }}" alt="{{ heading_title }}" class="img-thumbnail"/></a>&nbsp;
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
        
        <div class="col-sm-6">
                <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
          <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
          <h1>{{ heading_title }}</h1>
          
          {% if price_formatted %}
            <ul class="list-unstyled">
              <li><h2><span class="price-new">{{ price_formatted }}</span></h2></li>
            </ul>
          {% endif %}

          <div class="mb-2">
            {% set current_name = null %}
            {% for subscription in subscriptions %}
              {% if subscription.subscription_plan_id == subscription_plan_id or subscription.id == subscription_plan_id %}
                {% set current_name = subscription.name %}
              {% endif %}
            {% endfor %}
            <label class="form-label">Select your subscription: <small class="text-muted">{{ current_name|default('none selected') }}</small></label>
          </div>

            <div class="mb-3">
            <div class="d-flex flex-wrap gap-2" role="group" aria-label="Subscription plans">
              {% for subscription in subscriptions %}
              <button type="button"
                  class="btn-subscription btn btn-outline-dark btn-lg {% if subscription.subscription_plan_id == subscription_plan_id or subscription.id == subscription_plan_id %}active{% endif %}"
                  data-id="{{ subscription.subscription_plan_id|default(subscription.id) }}"
                  aria-pressed="{% if subscription.subscription_plan_id == subscription_plan_id or subscription.id == subscription_plan_id %}true{% else %}false{% endif %}">
                {{ subscription.name }}
              </button>
              {% endfor %}
            </div>
            </div>

          
          <div class="mb-3">
            <div class="mb-2">
              {% set current_freq_name = null %}
              {% for frequency in frequencies %}
                {% if frequency.frequency_id == frequency_id or frequency.id == frequency_id %}
                  {% set current_freq_name = frequency.name %}
                {% endif %}
              {% endfor %}
              <label class="form-label">Select payment frequency: <small id="selectedFrequency" class="text-muted"></small></label>
            </div>

            <div class="d-flex flex-wrap gap-2" role="group" aria-label="Payment frequencies">
              {% for frequency in frequencies %}
                <label class="btn-frequency btn btn-outline-dark btn-lg {% if loop.first %}active{% endif %}">
                  <input type="radio"
                         name="frequency_id"
                         class="d-none"
                         value="{{ frequency.frequency_id }}"
                         {% if loop.first %}checked{% endif %}
                         data-label="{{ frequency.name }}" />
                  {{ frequency.name }}
                </label>
              {% endfor %}
            </div>
          </div>
          
          <br/>

          <div class="mb-3">
            <div class="mb-2">
              <label class="form-label">Is this a Gift?</label>
            </div>

            <div class="d-flex gap-2" role="group" aria-label="Gift option">
              <label class="btn-gift-option btn btn-outline-dark btn-lg active">
                <input type="radio" name="is_gift" class="d-none" value="no" checked />
                No
              </label>
              <label class="btn-gift-option btn btn-outline-dark btn-lg">
                <input type="radio" name="is_gift" class="d-none" value="yes" />
                Yes
              </label>
            </div>
          </div>



          <div class="mb-3 duration-section">
            <div class="mb-2">
              {% set current_duration_name = null %}
              {% for duration in durations %}
                {% if duration.duration_id == duration_id or duration.id == duration_id %}
                  {% set current_duration_name = duration.name %}
                {% endif %}
              {% endfor %}
              <label class="form-label">Select duration: <small id="selectedDuration" class="text-muted">{{ current_duration_name|default('none selected') }}</small></label>
            </div>

            <div class="d-flex flex-wrap gap-2" role="group" aria-label="Durations">
                <label id="ongoing-duration" class="btn-duration btn btn-outline-dark btn-lg active">
                  <input type="radio"
                         name="duration_id"
                         class="d-none"
                         value="0"
                         checked
                         data-label="On Going" />
                  On Going
                </label>
              {% for duration in durations %}
                <label class="btn-duration btn btn-outline-dark btn-lg gift-duration">
                  <input type="radio"
                         name="duration_id"
                         class="d-none"
                         value="{{ duration.duration_id }}"
                         data-label="{{ duration.label }}" />
                  {{ duration.label }}
                </label>
              {% endfor %}
            </div>
          </div>

        

          {% if gifts %}
          <div class="mb-3 gifts-section" style="display: none;">
            <div class="mb-2">
              {% set current_gift_name = null %}
              {% for gift in gifts %}
                {% if gift.product_id == gift_id or gift.id == gift_id %}
                  {% set current_gift_name = gift.name %}
                {% endif %}
              {% endfor %}
              <label class="form-label">Select gift: <small id="selectedGift" class="text-muted">{{ current_gift_name|default('None') }}</small></label>
            </div>

            <div class="d-flex flex-wrap image-btns" role="group" aria-label="Gifts">
              <label
                class="btn-gift btn active"
                data-id="0"
                data-name="None"
                aria-pressed="true"
                title="None"
              >
                <input type="radio"
                       name="gift_option"
                       class="d-none"
                       value="0"
                       checked/>
                <div class="img-thumbnail d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 12px; font-weight: bold;">None</div>
              </label>
              {% for gift in gifts %}
                <label
                  class="btn-gift btn"
                  data-id="{{ gift.product_id|default(gift.id) }}"
                  data-name="{{ gift.name }}"
                  aria-pressed="false"
                  title="{{ gift.name }}"
                >
                  <input type="radio"
                         name="gift_option"
                         class="d-none"
                         value="{{ gift.product_id|default(gift.id) }}"/>
                  <img src="{{ gift.image }}" alt="{{ gift.name }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" />
                </label>
              {% endfor %}
            </div>

            <input type="hidden" id="gift_id" name="gift_id" value="0" />
          </div>

          {% endif %}

          {% if vases %}
          <div class="mb-3 vases-section">
            <div class="mb-2">
              {% set current_vase_name = null %}
              {% for vase in vases %}
                {% if vase.product_id == vase_id or vase.id == vase_id %}
                  {% set current_vase_name = vase.name %}
                {% endif %}
              {% endfor %}
              <label class="form-label">Select vase: <small id="selectedVase" class="text-muted">{{ current_vase_name|default('None') }}</small></label>
            </div>

            <div class="d-flex flex-wrap image-btns" role="group" aria-label="Vases">
              <label
                class="btn-vase btn active"
                data-id="0"
                data-name="None"
                aria-pressed="true"
                title="None"
              >
                <input type="radio"
                       name="vase_option"
                       class="d-none"
                       value="0"
                       checked/>
                <div class="img-thumbnail d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 12px; font-weight: bold;">None</div>
              </label>
              {% for vase in vases %}
                <label
                  class="btn-vase btn"
                  data-id="{{ vase.product_id|default(vase.id) }}"
                  data-name="{{ vase.name }}"
                  aria-pressed="false"
                  title="{{ vase.name }}"
                >
                  <input type="radio"
                         name="vase_option"
                         class="d-none"
                         value="{{ vase.product_id|default(vase.id) }}"/>
                  <img src="{{ vase.image }}" alt="{{ vase.name }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" />
                </label>
              {% endfor %}
            </div>

            <input type="hidden" id="vase_id" name="vase_id" value="0" />
          </div>

          {% endif %}

          <div id="subscription">
            <button type="button" id="button-subscribe" class="btn btn-primary btn-lg btn-block">
              <span class="priceFinal">{{ price_formatted }}</span> PER DELIVERY - SELECT YOUR DELIVERY DATE
            </button>

            <!-- Date Selection Modal/Section -->
            <div id="date-selection-container" style="display: none;" class="mt-3 col-8">
              <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-4">When would you like them delivered?</h5>
                <div class="mb-3">
                  <div id="delivery-calendar"></div>
                  <input type="hidden" id="delivery-date" />
                </div>
                <button type="button" id="button-add-to-cart" class="mt-4 btn btn-primary btn-lg w-100">
                <span class="priceFinal">{{ price_formatted }}</span>  PER DELIVERY - SET DELIVERY DATE
                </button>
              </div>
              </div>
            </div>

            <style>
              #button-add-to-cart {
                font-size: small;
              }
            #delivery-calendar {
              max-width: 100%;
              margin: 0 auto;
              background-color: #f8f9fa;
            }
            .calendar-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1rem;
              padding: 0.5rem;
              background-color: #f8f9fa;
              border-radius: 0.25rem;
            }
            .calendar-header button {
              background: none;
              border: none;
              font-size: 1.2rem;
              cursor: pointer;
              padding: 0.25rem 0.75rem;
            }
            .calendar-header h6 {
              margin: 0;
              font-weight: 600;
            }
            .calendar-grid {
              display: grid;
              grid-template-columns: repeat(7, 1fr);
              gap: 0.5rem;
            }
            .calendar-day-header {
              text-align: center;
              font-weight: 600;
              font-size: 0.875rem;
              color: #6c757d;
            }
            .calendar-day {
              aspect-ratio: 1;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              transition: all 0.2s;
              background-color: #fff;
              font-size: 0.875rem;
              border-radius: 25px;
            }
            .calendar-day:hover:not(.disabled):not(.other-month) {
              background-color: #e9ecef;
              border-color: #020202ff;
            }
            .calendar-day.selected {
              background-color: #000000ff;
              color: white;
              border-color: #000000ff;
              font-weight: 600;
            }
            .calendar-day.disabled {
              background-color: #f8f9fa;
              color: #adb5bd;
              cursor: not-allowed;
            }
            .calendar-day.other-month {
              color: #ced4da;
            }
            .calendar-day.today {
              border: 2px solid #010101ff;
              font-weight: 600;
            }
            #date-selection-container .card {
              border: none !important;
            }
            #date-selection-container .card-title {
              text-transform: uppercase;
            }
            </style>

          </div>
        </div>
      </div>
      
      {% if description %}
        <ul class="nav nav-tabs">
          <li class="nav-item"><a href="#tab-description" data-bs-toggle="tab" class="nav-link active">{{ tab_description }}</a></li>
          <li class="nav-item"><a href="#tab-delivery" data-bs-toggle="tab" class="nav-link">Delivery</a></li>
          <li class="nav-item"><a href="#tab-care" data-bs-toggle="tab" class="nav-link">Care</a></li>
        </ul>
        <div class="tab-content">
          <div id="tab-description" class="tab-pane active">{{ description }}</div>
          <div id="tab-delivery" class="tab-pane">
            <h4>Delivery Information</h4>
            <p>We offer flexible delivery options for your flower subscription:</p>
            <ul>
              <li><strong>Standard Delivery:</strong> Monday to Friday between 9 AM - 6 PM</li>
              <li><strong>Express Delivery:</strong> Same-day delivery available for orders placed before 12 PM</li>
              <li><strong>Subscription Delivery:</strong> Choose your preferred delivery day each week/month</li>
              <li><strong>Coverage Area:</strong> We deliver across the entire city and surrounding suburbs</li>
            </ul>
            <p>All flowers are carefully packaged to ensure they arrive fresh and beautiful. Our delivery team takes special care to handle each arrangement with attention.</p>
            <p><strong>Note:</strong> Delivery times may vary during peak seasons and holidays. We'll always keep you informed about your delivery status.</p>
          </div>
          <div id="tab-care" class="tab-pane">
            <h4>Flower Care Instructions</h4>
            <p>To keep your flowers fresh and vibrant for as long as possible, follow these simple care tips:</p>
            <ul>
              <li><strong>Water:</strong> Change the water every 2-3 days and use clean, room temperature water</li>
              <li><strong>Trimming:</strong> Cut stems at a 45-degree angle every few days to help water absorption</li>
              <li><strong>Placement:</strong> Keep flowers away from direct sunlight, heat sources, and drafts</li>
              <li><strong>Food:</strong> Use the provided flower food in the water to extend freshness</li>
              <li><strong>Leaves:</strong> Remove any leaves that fall below the water line to prevent bacteria growth</li>
            </ul>
            <p><strong>Temperature:</strong> Flowers last longer in cool environments (65-72Â°F is ideal).</p>
            <p><strong>Avoid:</strong> Keep flowers away from ripening fruit, which releases ethylene gas that can shorten flower life.</p>
            <p>With proper care, most arrangements will stay fresh for 7-14 days.</p>
          </div>
        </div>
      {% endif %}
      
      {{ related }}
      {{ content_bottom }}
    </div>
    {{ column_right }}
  </div>
</div>

<script type="text/javascript"><!--
$(document).ready(function() {
  // Magnific Popup for images
  $('.image').magnificPopup({
    type: 'image',
    delegate: 'a',
    gallery: {
      enabled: true
    }
  });

  // Subscription plan selection
  document.querySelectorAll('.btn-subscription').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = this.getAttribute('data-id');
      var url = new URL(window.location.href);
      url.searchParams.set('subscription_plan_id', id);
      window.location = url.toString();
    });
  });

  // Frequency selection
  (function(){
    var label = document.getElementById('selectedFrequency');
    var checkedFreq = document.querySelector('input[name="frequency_id"]:checked');
    if (label && checkedFreq) {
      label.textContent = checkedFreq.getAttribute('data-label');
    }

    document.querySelectorAll('.btn-frequency').forEach(function(btn){
      btn.addEventListener('click', function(){
        var radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        if (label) label.textContent = radio.getAttribute('data-label');
        document.querySelectorAll('.btn-frequency').forEach(function(b){
          b.classList.remove('active');
        });
        this.classList.add('active');
      });
    });
  })();

  // Gift option toggle
  (function(){
    var durationSection = $('.gift-duration');
    durationSection.hide();
    var giftsSection = document.querySelector('.gifts-section');
    var ongoingDurationBtn = document.getElementById('ongoing-duration');
    var vasesSection = document.querySelector('.vases-section');

    document.querySelectorAll('.btn-gift-option').forEach(function(btn){
      btn.addEventListener('click', function(){
        var radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        
        document.querySelectorAll('.btn-gift-option').forEach(function(b){
          b.classList.remove('active');
        });
        this.classList.add('active');

        if (radio.value === 'yes') {
          durationSection.show();
          if (giftsSection) giftsSection.style.display = 'block';
          ongoingDurationBtn.classList.remove('active');
          ongoingDurationBtn.style.display = 'none';
          durationSection[0].classList.add('active');
          var firstGiftDuration = durationSection[0].querySelector('input[type="radio"]');
          if (firstGiftDuration) firstGiftDuration.checked = true;
          if (vasesSection) vasesSection.style.display = 'none';
        } else {
          durationSection.hide();
          if (giftsSection) giftsSection.style.display = 'none';
          if (vasesSection) vasesSection.style.display = 'block';
          ongoingDurationBtn.classList.add('active');
          ongoingDurationBtn.style.display = 'block';
          var ongoingRadio = ongoingDurationBtn.querySelector('input[type="radio"]');
          if (ongoingRadio) ongoingRadio.checked = true;
        }
      });
    });
  })();

  // Duration selection
  (function(){
    var label = document.getElementById('selectedDuration');
    var checkedDuration = document.querySelector('input[name="duration_id"]:checked');
    if (label && checkedDuration) {
      label.textContent = checkedDuration.getAttribute('data-label');
    }

    document.querySelectorAll('.btn-duration').forEach(function(btn){
      btn.addEventListener('click', function(){
        var radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        document.querySelectorAll('.btn-duration').forEach(function(b){
          b.classList.remove('active');
        });
        this.classList.add('active');
        if (label) label.textContent = radio.getAttribute('data-label');
      });
    });
  })();

  // Gift selection
  (function(){
    var label = document.getElementById('selectedGift');
    var hidden = document.getElementById('gift_id');

    if (label && !label.textContent.trim()) {
      label.textContent = 'None';
    }
    if (hidden) hidden.value = '0';

    document.querySelectorAll('.btn-gift').forEach(function(btn){
      btn.addEventListener('click', function(){
        document.querySelectorAll('.btn-gift').forEach(function(b){
          b.classList.remove('active');
          b.setAttribute('aria-pressed','false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed','true');

        if (label) label.textContent = this.getAttribute('data-name') || this.getAttribute('title');
        if (hidden) hidden.value = this.getAttribute('data-id');
      });
    });
  })();

  // Vase selection
  (function(){
    var label = document.getElementById('selectedVase');
    var hidden = document.getElementById('vase_id');

    if (label && !label.textContent.trim()) {
      label.textContent = 'None';
    }
    if (hidden) hidden.value = '0';

    document.querySelectorAll('.btn-vase').forEach(function(btn){
      btn.addEventListener('click', function(){
        document.querySelectorAll('.btn-vase').forEach(function(b){
          b.classList.remove('active');
          b.setAttribute('aria-pressed','false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed','true');

        if (label) label.textContent = this.getAttribute('data-name') || this.getAttribute('title');
        if (hidden) hidden.value = this.getAttribute('data-id');
        this.querySelector('input[type="radio"]').checked = true;
      });
    });
  })();

  // Calendar and Add to Cart
  (function(){
    var subscribeBtn = document.getElementById('button-subscribe');
    var dateContainer = document.getElementById('date-selection-container');
    var addToCartBtn = document.getElementById('button-add-to-cart');
    var deliveryDateInput = document.getElementById('delivery-date');
    var today = new Date();
    today.setHours(0, 0, 0, 0);

    var todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    deliveryDateInput.value = todayStr;

    // Initialize Calendar instance
    var calendar = new Calendar('delivery-calendar', {
      minDate: today,
      defaultDate: today,
      onDateSelect: function(dateStr) {
        deliveryDateInput.value = dateStr;
      }
    });

    subscribeBtn.addEventListener('click', function(){
      dateContainer.style.display = 'block';
      subscribeBtn.style.display = 'none';
      if (!document.getElementById('delivery-calendar').innerHTML) {
        calendar.render();
      }
      dateContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    addToCartBtn.addEventListener('click', function(){
      var deliveryDate = deliveryDateInput.value;
      if (!deliveryDate) {
        alert('Please select a delivery date');
        return;
      }

      var frequencyRadio = document.querySelector('input[name="frequency_id"]:checked');
      var isGiftRadio = document.querySelector('input[name="is_gift"]:checked');
      var durationRadio = document.querySelector('input[name="duration_id"]:checked');
      var giftRadio = document.querySelector('input[name="gift_option"]:checked');
      var vaseRadio = document.querySelector('input[name="vase_option"]:checked');

      var subscriptionData = {
        subscription_plan_id: {{ subscription_plan_id }},
        product_id: 0,
        quantity: 1,
        delivery_date: deliveryDate,
        frequency_id: frequencyRadio ? frequencyRadio.value : '',
        is_gift: isGiftRadio ? isGiftRadio.value : 'no',
        duration_id: durationRadio ? durationRadio.value : '0',
        gift_id: giftRadio ? giftRadio.value : '0',
        vase_id: vaseRadio ? vaseRadio.value : '0'
      };

      console.log('Subscription Data:', subscriptionData);

      addToCartBtn.disabled = true;
      var originalText = addToCartBtn.innerHTML;
      addToCartBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Adding to Cart...';

      $.ajax({
        url: 'index.php?route=checkout/cart.add&language={{ config_language }}',
        type: 'post',
        data: subscriptionData,
        dataType: 'json',
        success: function(json) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;

          if (json['error']) {
            var errorMsg = json['error']['warning'] || json['error']['subscription'] || 'An error occurred. Please try again.';
            $('#content').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa-solid fa-circle-exclamation"></i> ' + errorMsg + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
            $('html, body').animate({ scrollTop: 0 }, 'slow');
          }

          if (json['success']) {
            // Show popup modal if available
            if (json['popup_html'] && typeof showCartPopup === 'function') {
              showCartPopup(json['popup_html']);
            } else {
              // Fallback to alert
              $('#content').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-circle-check"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
              $('html, body').animate({ scrollTop: 0 }, 'slow');
            }
            $('#header-cart').load('index.php?route=common/cart.info&language={{ config_language }}');
            setTimeout(function() {
              dateContainer.style.display = 'none';
              subscribeBtn.style.display = 'block';
            }, 1500);
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;
          console.error('AJAX Error:', thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
          alert('An error occurred while adding to cart. Please try again.');
        }
      });
    });
  })();
});
//--></script>

{{ footer }}
