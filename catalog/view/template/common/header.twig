<!DOCTYPE html>
<html dir="{{ direction }}" lang="{{ lang }}">

<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{{ title }}</title>
  <base href="{{ base }}"/>
  {% if description %}
    <meta name="description" content="{{ description }}"/>
  {% endif %}
  {% if keywords %}
    <meta name="keywords" content="{{ keywords }}"/>
  {% endif %}
  <script src="{{ jquery }}" type="text/javascript"></script>
  <link href="{{ bootstrap }}" type="text/css" rel="stylesheet" media="screen"/>
  <link href="{{ icons }}" rel="stylesheet" type="text/css"/>
  <link href="{{ stylesheet }}" type="text/css" rel="stylesheet"/>
  <script src="catalog/view/javascript/common.js" type="text/javascript"></script>
  {% if icon %}
    <link rel="icon" href="{{ icon }}" type="image/png">
  {% endif %}
  {% for style in styles %}
    <link href="{{ style.href }}" type="text/css" rel="{{ style.rel }}" media="{{ style.media }}"/>
  {% endfor %}
  {% for script in scripts %}
    <script src="{{ script.href }}" type="text/javascript"></script>
  {% endfor %}
  {% for link in links %}
    <link href="{{ link.href }}" rel="{{ link.rel }}"/>
  {% endfor %}
  {% for analytic in analytics %}
    {{ analytic }}
  {% endfor %}
</head>

<body>
   <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    

                    <!-- 1. Address Input (Priority/Top) -->
                    <div id="autocompleteInputGroup" class="mb-4 border p-3 rounded-3 bg-light">
                        <label for="districtInput" class="form-label fw-bold">Type Full Address (Google Suggestions)</label>
                        <!-- Address input is now enabled by default -->
                        <input type="text" class="form-control" id="districtInput" placeholder="Start typing your full address (e.g., Levent, Istanbul)...">
                        <div class="form-text text-muted mt-2">Selecting a Google suggestion will automatically fill in the City and District below.</div>
                    </div>

                    <!-- 2. Manual Selection Dropdowns -->
                    <div class="p-3 border rounded-3">
                         <label class="form-label fw-bold mb-3"> OR Manual City / District Selection (Optional)</label>
                        
                        <!-- 2a. City Dropdown -->
                        <div class="mb-3">
    <label for="cityDropdown" class="form-label">ƒ∞l (≈ûehir)</label>
    <select class="form-select" id="cityDropdown">
        <option selected value="">Bir ƒ∞l Se√ßiniz...</option>
        <option value="ƒ∞stanbul">ƒ∞stanbul</option>
        <option value="Ankara">Ankara</option>
        <option value="ƒ∞zmir">ƒ∞zmir</option>
        <option value="Antalya">Antalya</option>
        <option value="Bursa">Bursa</option>
        <option value="Adana">Adana</option>
        <option value="Gaziantep">Gaziantep</option>
        <option value="Konya">Konya</option>
    </select>
</div>

                        <!-- 2b. District Dropdown -->
                        <div id="manualInputGroup" class="mb-3">
                            <label for="manualDistrictDropdown" class="form-label">District (ƒ∞l√ße)</label>
                            <select class="form-select" id="manualDistrictDropdown" disabled>
                                <option selected value="">Select a District...</option>
                            </select>
                        </div>
                    </div>
                   

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveLocationBtn" disabled>Save Location</button>
                </div>
            </div>
        </div>
    </div>
  
  <div id="container" class="d-flex flex-column min-vh-100">
    <div id="alert"></div>
    <nav id="top">
      <div class="container">
        <div class="row">
          <div class="col-4" id="top-left">
            <ul class="list-inline">
              <li class="list-inline-item">
                <div class="dropdown">
                  <a href="#" class="dropdown-toggle" data-bs-toggle="modal" data-bs-target="#locationModal" aria-label="Select location">
                    <i class="fa-solid fa-location-dot"></i> <span class="d-none d-lg-inline">Your Location</span>
                  </a>
                </div>
              </li>
              <li class="list-inline-item">{{ language }}</li>
              <li class="list-inline-item"><a href="{{ contact }}"><i class="fa-solid fa-phone"></i> <span class="d-none d-lg-inline">{{ telephone }}</span></a></li>
            </ul>
          </div>
          <div class="col-12 col-md-4 d-flex justify-content-center align-items-center">
            <a href="{{ home }}" class="d-inline-block text-center">
              <img src="{{ logo }}" title="{{ name }}" alt="{{ name }}" class="img-fluid" />
            </a>
          </div>

          <div class="col-4 text-end">
            <ul class="list-inline">
              <li class="list-inline-item">
                <a href="#" id="toggle-search" aria-label="Toggle search"><i class="fa-solid fa-search"></i></a>
              </li>


              
              <li class="list-inline-item">
                <div class="dropdown">
                  <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown"><i class="fa-regular fa-user"></i> <span class="d-none d-lg-inline"></span> </a>
                  <ul class="dropdown-menu dropdown-menu-right">
                    {% if not logged %}
                    <li><a href="{{ register }}" class="dropdown-item">{{ text_register }}</a></li>
                    <li><a href="{{ login }}" class="dropdown-item">{{ text_login }}</a></li>
                    {% else %}
                    <li><a href="{{ account }}" class="dropdown-item">{{ text_account }}</a></li>
                    <li><a href="{{ order }}" class="dropdown-item">{{ text_order }}</a></li>
                    <li><a href="{{ transaction }}" class="dropdown-item">{{ text_transaction }}</a></li>
                    <li><a href="{{ download }}" class="dropdown-item">{{ text_download }}</a></li>
                    <li><a href="{{ logout }}" class="dropdown-item">{{ text_logout }}</a></li>
                    {% endif %}
                  </ul>
                </div>
              </li>
              <li class="list-inline-item"><a href="{{ wishlist }}" id="wishlist-total" title="{{ text_wishlist }}"><i class="fa-regular fa-heart"></i> <span class="d-none d-lg-inline"></span></a></li>
              <li class="list-inline-item"><a href="{{ shopping_cart }}" title="{{ text_shopping_cart }}"><i class="fa-solid fa-cart-shopping"></i> <span class="d-none d-lg-inline"></span></a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
    <header>
      <div class="container">
        <div class="row">
          <div class="col">
            {{ search }}
        </div>
      </div>
    </header>
    <main class="flex-grow-1 mb-4">
      {{ menu }}

                    <script>
              document.addEventListener('DOMContentLoaded', function() {
                var toggle = document.getElementById('toggle-search');
                var searchContainer = document.querySelector('header .container .row .col');

                if (!toggle || !searchContainer) return;

                // Hide search bar by default
                searchContainer.style.display = 'none';

                toggle.addEventListener('click', function(e) {
                  e.preventDefault();

                  var isHidden = getComputedStyle(searchContainer).display === 'none';

                  if (isHidden) {
                    searchContainer.style.display = 'block';
                    // focus the first input in the search block if present
                    var input = searchContainer.querySelector('input[type="search"], input[type="text"], input');
                    if (input) input.focus();
                  } else {
                    searchContainer.style.display = 'none';
                  }
                });
              });
             
        // CRITICAL: Replace THIS_IS_YOUR_GOOGLE_MAPS_API_KEY with your actual API key
        // Ensure the Google Maps API key has the 'Places API' enabled.
        const GOOGLE_API_KEY = "{{ google_api_key }}"; 

        // JSON list of cities and common districts for manual selection
        const turkishCitiesAndDistricts = {
            "ƒ∞stanbul": [
                "Adalar", "Arnavutk√∂y", "Ata≈üehir", "Avcƒ±lar", "Baƒücƒ±lar", 
                "Bah√ßelievler", "Bakƒ±rk√∂y", "Ba≈üak≈üehir", "Bayrampa≈üa", "Be≈üikta≈ü", 
                "Beykoz", "Beylikd√ºz√º", "Beyoƒülu", "B√ºy√ºk√ßekmece", "√áatalca", 
                "√áekmek√∂y", "Esenler", "Esenyurt", "Ey√ºpsultan", "Fatih", 
                "Gaziosmanpa≈üa", "G√ºng√∂ren", "Kadƒ±k√∂y", "Kaƒüƒ±thane", "Kartal", 
                "K√º√ß√ºk√ßekmece", "Maltepe", "Pendik", "Sancaktepe", "Sarƒ±yer", 
                "Silivri", "Sultanbeyli", "Sultangazi", "≈ûile", "≈ûi≈üli", 
                "Tuzla", "√úmraniye", "√úsk√ºdar", "Zeytinburnu"
            ],
            "Ankara": [
                "Akyurt", "Altƒ±ndaƒü", "Aya≈ü", "Bal√¢", "Beypazarƒ±", "√áamlƒ±dere", 
                "√áankaya", "√áubuk", "Elmadaƒü", "Etimesgut", "Evren", "G√∂lba≈üƒ±", 
                "G√ºd√ºl", "Haymana", "Kahramankazan", "Kalecik", "Ke√ßi√∂ren", 
                "Kƒ±zƒ±lcahamam", "Mamak", "Nallƒ±han", "Polatlƒ±", "Pursaklar", 
                "Sincan", "≈ûerefliko√ßhisar", "Yenimahalle"
            ],
            "ƒ∞zmir": [
                "Aliaƒüa", "Bal√ßova", "Bayƒ±ndƒ±r", "Bayraklƒ±", "Bergama", "Beydaƒü", 
                "Bornova", "Buca", "√áe≈üme", "√áiƒüli", "Dikili", "Fo√ßa", 
                "Gaziemir", "G√ºzelbah√ße", "Karabaƒülar", "Karaburun", "Kar≈üƒ±yaka", 
                "Kemalpa≈üa", "Kƒ±nƒ±k", "Kiraz", "Konak", "Menderes", "Menemen", 
                "Narlƒ±dere", "√ñdemi≈ü", "Seferihisar", "Sel√ßuk", "Tire", 
                "Torbalƒ±", "Urla"
            ],
            "Antalya": [
                "Akseki", "Aksu", "Alanya", "Demre", "D√∂≈üemealtƒ±", "Elmalƒ±", 
                "Finike", "Gazipa≈üa", "G√ºndoƒümu≈ü", "ƒ∞bradƒ±", "Ka≈ü", "Kemer", 
                "Kepez", "Konyaaltƒ±", "Korkuteli", "Kumluca", "Manavgat", 
                "Muratpa≈üa", "Serik"
            ],
            "Bursa": [
                "B√ºy√ºkorhan", "Gemlik", "G√ºrsu", "Harmancƒ±k", "ƒ∞neg√∂l", "ƒ∞znik", 
                "Karacabey", "Keles", "Kestel", "Mudanya", "Mustafakemalpa≈üa", 
                "Nil√ºfer", "Orhaneli", "Orhangazi", "Osmangazi", "Yeni≈üehir", 
                "Yƒ±ldƒ±rƒ±m"
            ],
            "Adana": [
                "Aladaƒü", "Ceyhan", "√áukurova", "Feke", "ƒ∞mamoƒülu", "Karaisalƒ±", 
                "Karata≈ü", "Kozan", "Pozantƒ±", "Saimbeyli", "Sarƒ±√ßam", "Seyhan", 
                "Tufanbeyli", "Yumurtalƒ±k", "Y√ºreƒüir"
            ],
            "Gaziantep": [
                "Araban", "ƒ∞slahiye", "Karkamƒ±≈ü", "Nizip", "Nurdaƒüƒ±", 
                "Oƒüuzeli", "≈ûahinbey", "≈ûehitkamil", "Yavuzeli"
            ],
            "Konya": [
                "Ahƒ±rlƒ±", "Ak√∂ren", "Ak≈üehir", "Altƒ±nekin", "Bey≈üehir", "Bozkƒ±r", 
                "Cihanbeyli", "√áeltik", "√áumra", "Derbent", "Derebucak", "Doƒüanhisar", 
                "Emirgazi", "Ereƒüli", "G√ºneysƒ±nƒ±r", "Hadim", "Halkapƒ±nar", "H√ºy√ºk", 
                "Ilgƒ±n", "Kadƒ±nhanƒ±", "Karapƒ±nar", "Karatay", "Kulu", "Meram", 
                "Saray√∂n√º", "Sel√ßuklu", "Seydi≈üehir", "Ta≈ükent", "Tuzluk√ßu", 
                "Yalƒ±h√ºy√ºk", "Yunak"
            ]
        };
        
        let autocomplete;
        let isAutocompleteValid = false; // Flag to track if a Google place was successfully selected
        let isProgrammaticCityUpdate = false; // Flag to prevent clearing the address input on self-update

        // This function dynamically loads the Google Maps script
        function loadGoogleMapsScript() {
            if (document.getElementById('googleMapsScript')) {
                if (typeof google === 'object' && typeof google.maps === 'object') {
                    window.initAutocomplete();
                }
                return; 
            }
            
            const script = document.createElement('script');
            script.id = 'googleMapsScript';
            // Load the 'places' library for Autocomplete
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=places&callback=initAutocomplete`;
            script.async = true;
            document.head.appendChild(script);
        }

        // This function is called once the Google Maps script is fully loaded
        window.initAutocomplete = function() {
            const districtInput = document.getElementById('districtInput');
            
            // 3. Initialize Google Places Autocomplete
            autocomplete = new google.maps.places.Autocomplete(districtInput, {
                // Restrict results to Turkey
                componentRestrictions: { country: ["tr"] },
                // Suggest addresses (geocodes)
                types: ['geocode'], 
            });

            // 4. Listen for the place selection event
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                const saveBtn = document.getElementById('saveLocationBtn');
                const manualDropdown = document.getElementById('manualDistrictDropdown');
                const cityDropdown = document.getElementById('cityDropdown');

                if (place.geometry) {
                    isAutocompleteValid = true;
                    saveBtn.disabled = false;
                    
                    let districtName = null;
                    let cityName = null;

                    // 1. Extract City (administrative_area_level_1) and District (administrative_area_level_2)
                    for (const component of place.address_components) {
                        if (component.types.includes('administrative_area_level_1')) {
                            cityName = component.long_name;
                        }
                        if (component.types.includes('administrative_area_level_2')) {
                            districtName = component.long_name;
                        }
                    }
                    console.log(cityName);

                    console.log(districtName);
                    
                    // 2. Programmatically update the City Dropdown
                    if (cityName && turkishCitiesAndDistricts[cityName]) {
                        isProgrammaticCityUpdate = true; // Set flag
                        cityDropdown.value = cityName;
                        // Dispatch change event to populate the district dropdown
                        cityDropdown.dispatchEvent(new Event('change'));
                        isProgrammaticCityUpdate = false; // Clear flag
                    } else {
                        // Clear the city dropdown if city is not one of our hardcoded options
                        cityDropdown.value = "";
                        cityDropdown.dispatchEvent(new Event('change'));
                    }

                    // 3. Update the District Dropdown
                    const currentCity = cityDropdown.value;
                    if (districtName && currentCity && turkishCitiesAndDistricts[currentCity] && turkishCitiesAndDistricts[currentCity].includes(districtName)) {
                        manualDropdown.value = districtName;
                    } else {
                        // Clear the manual selection if the extracted district isn't found
                        manualDropdown.value = ""; 
                    }

                } else {
                    // If user types and leaves without selecting a valid suggestion
                    isAutocompleteValid = false;
                    // Re-check if save button should be enabled based on manual selection
                    saveBtn.disabled = !(cityDropdown.value && manualDropdown.value); 
                }
            });
            
            console.log("Google Places Autocomplete Initialized.");
        }
        
        // --- Geolocation Function (Get User's Real Location Link) ---
        function getUserLocationLink() {
            const button = document.getElementById('openLocationModalBtn');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const mapLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                        
                        // Update the button to be a link
                        button.innerHTML = `üìç View Your Current Location`;
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-info');
                        button.setAttribute('onclick', `window.open('${mapLink}', '_blank')`);
                        button.removeAttribute('data-bs-toggle');
                        button.removeAttribute('data-bs-target');
                        
                        // Create a separate link to open the selection modal
                        const container = document.querySelector('.container');
                        let modalLink = container.querySelector('.modal-selection-link');
                        if (!modalLink) {
                            const p = document.createElement('p');
                            p.className = 'mt-3 modal-selection-link';
                            p.innerHTML = `<a href="#" class="text-secondary" data-bs-toggle="modal" data-bs-target="#locationModal">Or click here to manually select a city/district.</a>`;
                            container.appendChild(p);
                        }
                        
                    },
                    (error) => {
                        console.error("Geolocation failed:", error);
                        button.innerHTML = `üìç Select Your Location`;
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }
        
        // --- Populate Manual Dropdown ---
        function populateManualDropdown(city) {
            const dropdown = document.getElementById('manualDistrictDropdown');
            dropdown.innerHTML = '<option selected value="">Select a District...</option>'; // Clear existing options
            
            if (!city || !turkishCitiesAndDistricts[city]) {
                dropdown.disabled = true;
                return;
            }
            
            dropdown.disabled = false;
            turkishCitiesAndDistricts[city].forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                dropdown.appendChild(option);
            });
        }

        // --- Main Logic and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            const cityDropdown = document.getElementById('cityDropdown');
            const districtInput = document.getElementById('districtInput');
            const manualDistrictDropdown = document.getElementById('manualDistrictDropdown');
            const saveLocationBtn = document.getElementById('saveLocationBtn');
            const locationModal = document.getElementById('locationModal');
            
            // The address input is now enabled by default (removed the disabling line)
            manualDistrictDropdown.disabled = true;
            saveLocationBtn.disabled = true;

            
            
            // Load Google Maps script when the modal is about to be shown
            locationModal.addEventListener('show.bs.modal', loadGoogleMapsScript);

            
            // 5. Handle City Dropdown Change
            cityDropdown.addEventListener('change', () => {
                const city = cityDropdown.value;

                // If the update was not triggered programmatically (i.e., user clicked the dropdown)
                if (!isProgrammaticCityUpdate) {
                    // 1. Clear autocomplete input and validation state when user manually changes city
                    districtInput.value = '';
                    isAutocompleteValid = false;
                    
                    
                }
                
                // 3. Always update manual district dropdown based on selected city
                populateManualDropdown(city);
                
                // 4. Clear district dropdown value and re-evaluate save button state
                manualDistrictDropdown.value = '';
                saveLocationBtn.disabled = true;
            });
            
            // Listener for Manual District Dropdown change to enable save button
            manualDistrictDropdown.addEventListener('change', () => {
                const selectedCity = cityDropdown.value;
                const selectedDistrict = manualDistrictDropdown.value;
                // Enable if city and district are selected, REGARDLESS of autocomplete state
                saveLocationBtn.disabled = !(selectedCity && selectedDistrict);
            });
            
            // Listener for Autocomplete Input text entry (typing)
            // Typing disables autocomplete validation, but keeps save button enabled if manual is valid.
            districtInput.addEventListener('input', () => {
                isAutocompleteValid = false;
                // Only disable save button if neither autocomplete is valid nor manual is selected
                const selectedCity = cityDropdown.value;
                const selectedDistrict = manualDistrictDropdown.value;
                saveLocationBtn.disabled = !(isAutocompleteValid || (selectedCity && selectedDistrict)); 
            });


            // 6. Handle Save Button Click
            saveLocationBtn.addEventListener('click', () => {
                const selectedCity = cityDropdown.value;
                
                let selectedLocation;
                let source;

                // Priority 1: Google Autocomplete (Full Address) - most specific
                if (isAutocompleteValid) {
                    selectedLocation = districtInput.value;
                    source = "(Google Address)";
                } 
                // Priority 2: Manual Dropdown (District Name)
                else if (manualDistrictDropdown.value) {
                    selectedLocation = manualDistrictDropdown.value;
                    source = "(Manual District)";
                } else {
                     selectedLocation = null;
                }

                if (selectedCity && selectedLocation) {
                    const display = document.getElementById('currentLocationDisplay');
                    display.innerHTML = `‚úÖ **Selected Location:** **${selectedLocation}**, **${selectedCity}** ${source}`;
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(locationModal);
                    modal.hide();
                    
                } 
            });
            
            // 7. Initial Geolocation Call
            getUserLocationLink();
        });
    </script>